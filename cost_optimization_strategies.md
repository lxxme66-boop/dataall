# DeepSeek-R1 成本优化策略

## 📊 当前成本分析

### 原始方案
- **API调用次数**: 30,000次 (5000文档 × 6次/文档)
- **Token消耗**: 1.5亿 tokens
  - 输入: 7500万 tokens × ¥4/百万 = ¥300
  - 输出: 7500万 tokens × ¥16/百万 = ¥1,200
- **总成本**: ¥1,500

## 🚀 优化策略

### 1. 批量推理优化（最有效）
**核心思想**: 将多个文档的处理合并到单次API调用中

#### 实施方案：
- **批处理规模**: 10个文档/批次
- **API调用减少**: 30,000次 → 1,000次（减少96.7%）
- **预期成本**: ¥300-400（节省70-80%）

```python
# 原方案：每个文档6次调用
for doc in documents:
    questions = generate_questions(doc)  # 1次API
    for q in questions:
        answer = generate_answer(q)  # 5次API
        
# 优化方案：批量处理
batch_docs = documents[i:i+10]
all_questions = batch_generate_questions(batch_docs)  # 1次API处理10个文档
all_answers = batch_generate_answers(all_questions)  # 1次API生成所有答案
```

### 2. Token优化策略

#### 2.1 提示词压缩
- **上下文截断**: 1500字 → 500字（减少66%）
- **移除冗余**: 精简指令，使用简洁格式
- **智能摘要**: 对长文本先摘要再处理

#### 2.2 输出格式优化
- **JSON紧凑格式**: 减少格式化字符
- **批量返回**: 一次返回多个结果
- **限制输出长度**: max_tokens从4096→800

### 3. 缓存机制

#### 3.1 结果缓存
- **问题缓存**: 相似文档复用问题模板
- **答案模板**: 常见问题类型的答案模板
- **增量处理**: 只处理新增内容

#### 3.2 去重优化
- **文档去重**: 识别相似文档，避免重复处理
- **问题去重**: 合并相似问题
- **预期节省**: 15-20%的API调用

### 4. 智能采样策略

#### 4.1 文档采样
- **质量优先**: 选择信息密度高的文档
- **代表性采样**: 确保覆盖各类主题
- **动态调整**: 根据已生成数量动态调整采样率

#### 4.2 分层处理
```python
# 高质量文档：生成更多QA对
high_quality_docs → 6-8 QA pairs/doc

# 普通文档：标准处理
normal_docs → 3-4 QA pairs/doc  

# 低质量文档：最少处理
low_quality_docs → 1-2 QA pairs/doc
```

## 💰 优化效果对比

| 指标 | 原始方案 | 优化后 | 节省比例 |
|------|---------|--------|----------|
| API调用次数 | 30,000 | 1,000-2,000 | 93-96% |
| 输入Tokens | 7500万 | 2000-3000万 | 60-73% |
| 输出Tokens | 7500万 | 1500-2500万 | 67-80% |
| 总成本 | ¥1,500 | ¥300-500 | 67-80% |

## 🔧 实施步骤

### 第一阶段：批量处理（立即实施）
1. 实现批量API调用
2. 合并文档处理
3. 预期节省：60-70%

### 第二阶段：Token优化（1-2天）
1. 压缩提示词模板
2. 优化输出格式
3. 预期额外节省：10-15%

### 第三阶段：智能优化（3-5天）
1. 实现缓存系统
2. 文档质量分级
3. 智能采样
4. 预期额外节省：5-10%

## 🎯 最终目标

- **成本控制**: 从¥1,500降至¥300-500
- **质量保证**: 维持或提升QA对质量
- **效率提升**: 处理速度提升3-5倍
- **可扩展性**: 支持更大规模数据处理

## 📝 注意事项

1. **质量监控**: 批量处理时需要验证输出质量
2. **错误处理**: 实现重试机制和降级策略
3. **渐进优化**: 分阶段实施，确保稳定性
4. **A/B测试**: 对比优化前后的质量差异

## 🛠️ 使用方法

```bash
# 使用优化后的批量处理器
export DEEPSEEK_API_KEY="your_api_key"
python deepseek_batch_optimizer.py data/texts data/output

# 或集成到现有流程
python run_large_scale_qa.py \
    --use-deepseek \
    --enable-batch-optimization \
    --batch-size 10 \
    --target-qa-count 20000
```